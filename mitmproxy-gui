#!/usr/bin/env python
import sys, argparse, signal, webbrowser
from libmproxy import proxy, dump, app

if __name__ == '__main__':
    parser = argparse.ArgumentParser(usage = "%(prog)s [options] [filter]")
    dump.DumpMaster.add_arguments(parser)

    options = parser.parse_args()
    options.app = True

    server = proxy.get_server(options)

    m = dump.DumpMaster(server, options)

    # FIXME: If https://github.com/mitmproxy/mitmproxy/pull/161 gets merged..
    # - Replace default port
    # - force external app
    url = "http://%s:%d/app" % (options.app_domain, 80)
    if options.app_auth is not False:
        url += "?auth=%s" % app.auth_token()
    webbrowser.open(url)

    def cleankill(*args, **kwargs):
        m.shutdown()
    signal.signal(signal.SIGTERM, cleankill)
    try:
        m.run()
    except KeyboardInterrupt:
        pass